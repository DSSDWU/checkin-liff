<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #333;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    .status {
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 10px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-size: 16px;
    }
    input {
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      font-weight: bold;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE</h2>
    <div id="status" class="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <form id="form" style="display: none;">
      <input type="text" id="studentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (8 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="8" required />
      <input type="text" id="fullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required />
      <button type="submit" id="submitBtn">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
    </form>
  </div>

  <script>
    const liffId = '2007533400-9JaRBALJ'; // üëà ‡πÉ‡∏ä‡πâ LIFF ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const endpoint = 'https://script.google.com/macros/s/AKfycbyN9YjkgSYbh4dgLrcTclnRvtMfbEuUgsbUJ4_FvwGWwXZS9QOAJ56XiPZqVaHKnjhbzw/exec';
    const EVENT_LOCATION = { lat: 8.64545, lng: 99.89768 };
    const RADIUS_METER = 300;

    async function initApp() {
      try {
        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
          liff.login(); // ‡∏à‡∏∞ reload ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á login
          return;
        }

        const profile = await liff.getProfile();
        document.getElementById('status').textContent = `üë§ ${profile.displayName} - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...`;

        if (!navigator.geolocation) {
          updateStatus('‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
          return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const location = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };

          const dist = calculateDistance(location.lat, location.lng, EVENT_LOCATION.lat, EVENT_LOCATION.lng);

          if (dist > RADIUS_METER) {
            updateStatus(`‚ùå ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (${dist.toFixed(0)} ‡πÄ‡∏°‡∏ï‡∏£)`, 'error');
            document.getElementById('submitBtn').disabled = true;
          } else {
            updateStatus(`‚úÖ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ú‡πà‡∏≤‡∏ô (${dist.toFixed(0)} ‡πÄ‡∏°‡∏ï‡∏£)`, 'success');
            document.getElementById('form').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;

            document.getElementById('form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const studentId = document.getElementById('studentId').value.trim();
              const fullName = document.getElementById('fullName').value.trim();

              const payload = {
                uid: profile.userId,
                displayName: profile.displayName,
                studentId,
                fullName,
                location,
                timestamp: new Date().toISOString()
              };

              try {
                const res = await fetch(endpoint, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                const result = await res.json();
                updateStatus(result.success ? '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ' + result.message, result.success ? 'success' : 'error');
              } catch (err) {
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
              }
            });
          }
        }, () => {
          updateStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
        });

      } catch (err) {
        console.error('[LIFF ERROR]', err);
        updateStatus('‚ùå ‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    function updateStatus(text, type) {
      const div = document.getElementById('status');
      div.textContent = text;
      div.className = 'status ' + type;
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    window.onload = initApp;
  </script>
</body>
</html>
